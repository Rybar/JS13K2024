!function(){class e{constructor(t){this.seed=t,this.modulus=2**31-1,this.multiplier=48271,this.increment=0,this.state=t}next(){return this.state=(this.multiplier*this.state+this.increment)%this.modulus,this.state/this.modulus}randomInt(t,e){return Math.floor(this.next()*(e-t+1))+t}randomFloat(t,e){return this.next()*(e-t)+t}coinFlip(){return this.next()>.5}choice(t){return t[this.randomInt(0,t.length-1)]}}class i{constructor(t,i,s,h){this.WIDTH=t,this.HEIGHT=i,this.PAGESIZE=this.WIDTH*this.HEIGHT,this.PAGES=h,this.atlas=s,this.LCG=new e(3735928559),this.paintTransparent=!1,this.lightMode=!1,this.SCREEN=0;for(let t=1;this.PAGES>=t;t++)this["PAGE_"+t]=this.PAGESIZE*t;this.stencil=!1,this.stencilSource=this.PAGE_2,this.stencilOffset=0,this.colors=this.atlas.slice(0,64),this.tileGraphics=this.atlas.slice(512,4608),this.palDefault=Array.from({length:64},(t,e)=>e),this.c=document.createElement("canvas"),this.c.width=this.WIDTH,this.c.height=this.HEIGHT,this.ctx=this.c.getContext("2d"),this.renderTarget=0,this.renderSource=this.PAGESIZE,this.fontString="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890_!@#.'\"?/<()",this.fontBitmapBase64="/H8Y+j6PvwhB/JRj78OQ/+HIQ/C8fxj+MfkIT/xCl6MuSjCEIfjusYxzWcXRjF3oy5B0Yyf6PoxfBwffIQhIxjF0YxUSMa1dFRFRiohCfERHyMIRzoiJ/wTB9KXxC/DwfPh6LvhEQjoui50Xhc6MYuAAAPkIQBPxvW6vq+oAAAIYRAA2mQAOiYBAiIiAiIIIRCEE";const a=atob(this.fontBitmapBase64);this.fontBitmap=new Uint8Array(8*a.length);for(let t=0;a.length>t;t++){let e=a.charCodeAt(t);for(let i=0;8>i;i++)this.fontBitmap[8*t+i]=e>>7-i&1}this.pal=Array.from({length:64},(t,e)=>e),this.dither=[65535,65527,65015,65013,62965,62901,58805,58789,42405,42401,42145,42144,41120,40992,32800,32768,0,23130],this.pat=65535,this.ctx.imageSmoothingEnabled=!1,this.imageData=this.ctx.getImageData(0,0,this.WIDTH,this.HEIGHT),this.buf=new ArrayBuffer(this.imageData.data.length),this.buf8=new Uint8Array(this.buf),this.data=new Uint32Array(this.buf),this.ram=new Uint8Array(this.WIDTH*this.HEIGHT*this.PAGES),this.charBuffer=new Uint8Array(25),this.brightness=[];for(let t=0;6>t;t++)for(let e=0;64>e;e++)this.brightness[64*t+e]=this.colors.indexOf(this.atlas[64*t+e]);for(let t=0;64>t;t++)for(let e=0;72>e;e++)this.ram[this.PAGE_1+t+480*e]=this.colors.indexOf(this.tileGraphics[t+64*e])}clear(t,e){this.ram.fill(t,e,e+this.PAGESIZE)}pset(t,e,i,s=64){if(0>(t|=0)||t>this.WIDTH-1)return;if(0>(e|=0)||e>this.HEIGHT-1)return;const h=this.renderTarget+e*this.WIDTH+t,a=this.ram[h];65>i||i>70?i%=64:i=this.brightness[64*(i-65)+a],65>s||s>70?s%=64:s=this.brightness[64*(s-65)+a],r.lightMode&&(i=a>i?i:a,s=a>s?s:a);let o=this.pat&1<<e%4*4+t%4?i:s;(0!=o||this.paintTransparent)&&(this.ram[h]=o)}pget(t,e,i=0){return this.ram[i+(t|=0)+(e|=0)*this.WIDTH]}line(t,e,i,s,h,a=64){var r,o,n=(s|=0)-(e|=0),l=(i|=0)-(t|=0);if(0>n?(n=-n,o=-1):o=1,0>l?(l=-l,r=-1):r=1,n<<=1,l<<=1,this.pset(t,e,h,a),l>n)for(var c=n-(l>>1);t!=i;)0>c||(e+=o,c-=l),c+=n,this.pset(t+=r,e,h,a);else for(c=l-(n>>1);e!=s;)0>c||(t+=r,c-=n),c+=l,this.pset(t,e+=o,h,a)}polygon(t,e,i,s,h,a,r=64){if(3>s)return;const o=2*Math.PI/s;let n=t+i*Math.cos(h),l=e+i*Math.sin(h);for(let c=0;s>=c;c++){const s=c*o,d=t+i*Math.cos(s+h),y=e+i*Math.sin(s+h);this.line(n,l,d,y,a,r),n=d,l=y}}lCircle(t,e,i,s,h=64){t|=0,e|=0,s|=0;var a=-(i|=0),r=0,o=2-2*i;do{this.pset(t-a,e+r,s,h),this.pset(t-r,e-a,s,h),this.pset(t+a,e-r,s,h),this.pset(t+r,e+a,s,h),(i=o)>r||(o+=2*++r+1),(i>a||o>r)&&(o+=2*++a+1)}while(0>a)}fCircle(t,e,i,s,h=64){if(i>=0)for(let a=-i;i>a;a++){let r=Math.sqrt(i*i-a*a);for(let i=-r;r>i;i++)this.pset(t+a,e+i,s,h)}}colorLerp(t,e){const i=16*(e=Math.max(0,Math.min(1,e)))*(t.length-1),s=Math.floor(i/16);return{color1:t[s],color2:t[s+1]||t[s],ditherStep:Math.floor(i%16)}}radialCircle(t,e,i,s){for(let h=-i;i>=h;h++)for(let a=-i;i>=a;a++){const r=Math.sqrt(a*a+h*h);if(i>=r){const o=r/i,{color1:n,color2:l,ditherStep:c}=this.colorLerp(s,o);this.pat=this.dither[c],this.pset(t+a,e+h,n,l)}}this.pat=this.dither[0]}span(t,e,i,s,h=64){for(let a=t;e>=a;a++)this.pset(a,i,s,h)}lRect(t,e,i,s,h,a=64){let r=0|t,o=0|e,n=t+i|0,l=e+s|0;this.line(r,o,n,o,h=h,a),this.line(n,o,n,l,h,a),this.line(r,l,n,l,h,a),this.line(r,o,r,l,h,a)}fRect(t,e,i,s,h,a=64,r=0){let o=0|t,n=0|e,l=(t+i|0)-1,c=(e+s|0)-1;h=h,this.pat=this.dither[r];var d=Math.abs(c-n);if(this.span(o,l,n,h,a),d>0)for(;--d;)this.span(o,l,n+d,h,a);this.span(o,l,c,h,a),this.pat=this.dither[0]}sspr(t=0,e=0,i=16,s=16,h=0,a=0,r=32,o=32,n=!1,l=!1){for(var c=i/r,d=s/o,y=0;o>y;y++)for(var p=0;r>p;p++){let r=p*c|0,o=y*d|0,x=this.pget((t=n?i-r-p:t)+r,(e=l?s-o-y:e)+o,this.renderSource);x=this.pal[x],0!=x&&this.pset(h+p,a+y,x)}}spr(t=0,e=0,i=8,s=8,h=0,a=0){for(let r=0;s>r;r++)for(let s=0;i>s;s++){const i=this.pget(t+s,e+r,this.renderSource),o=this.pal[i];0!=o&&this.pset(h+s,a+r,o)}}drawTile(t,e,i,s,h=64){this.pal[0]=s,this.pal[22]=h;let a=t%8*8,r=8*Math.floor(t/8);this.renderSource=this.PAGE_1,this.spr(a,r,8,8,e,i),this.pal=this.palDefault.slice()}drawTileAsset(t,e,i){const{width:s,height:h,data:a}=i;for(let i=0;h>i;i++)for(let h=0;s>h;h++){if(-8>t+8*h||t+8*h>this.WIDTH)continue;const r=3*(i*s+h);this.drawTile(a[r],t+8*h,e+8*i,a[r+2],a[r+1])}}imageToRam(t,e){let i=document.createElement("canvas");i.width=this.WIDTH,i.height=this.HEIGHT;let s=i.getContext("2d");s.drawImage(t,0,0);let h=s.getImageData(0,0,this.WIDTH,this.HEIGHT),a=new Uint32Array(h.data.buffer);for(var r=0;a.length>r;r++)this.ram[e+r]=this.colors.indexOf(a[r])}render(){for(var t=this.PAGESIZE+1;t--;)t>0&&(this.data[t-1]=this.colors[this.pal[this.ram[t-1]]]);this.imageData.data.set(this.buf8),this.ctx.putImageData(this.imageData,0,0)}getCharacter(t,e){let i=25*this.fontString.indexOf(t);for(let t=0;25>t;t++)e[t]=this.fontBitmap[i+t];return e}textLine(t,e,i,s,h,a,r,o,n,l=64){for(var c=t.length,d=0;c>d;d++)for(var y=this.getCharacter(t.charAt(d),this.charBuffer),p=0;5>p;p++)for(var x=0;5>x;x++)1==y[5*p+x]&&(1==o?this.pset(e+x*o+(5*o+s)*d,i+p*o,n,l):this.fRect(e+x*o+(5*o+s)*d,i+p*o,o,o,n,l))}text(t,e,i,s,h,a,r,o,n){var l=5*o,c=t.split("\n"),d=c.slice(0),y=c.length,p=d.sort((t,e)=>e.length-t.length)[0],x=p.length*l+(p.length-1)*s,g=y*l+(y-1)*h;a||(a="left"),r||(r="bottom");var u=e,f=i,m=e+x,w=i+g;"center"==a?(u=e-x/2,m=e+x/2):"right"==a&&(u=e-x,m=e),"center"==r?(f=i-g/2,w=i+g/2):"bottom"==r&&(f=i-g,w=i);for(var A=u+x/2,T=f+g/2,M=0;y>M;M++){var E=c[M],C=E.length*l+(E.length-1)*s,v=e,S=i+(l+h)*M;"center"==a?v=e-C/2:"right"==a&&(v=e-C),"center"==r?S=i-g/2:"bottom"==r&&(S=i-g),this.textLine(E,v,S,s,h,a,r,o,n)}return{sx:u,sy:f,cx:A,cy:T,ex:m,ey:w,width:x,height:g}}}var s=function(){var t,e,i,s,h,a=t=>Math.sin(6.283184*t),r=t=>.003959503758*2**((t-128)/12),o=(t,e,i)=>{var s,h,a,o,l,c,d=n[t.i[0]],y=t.i[1],p=t.i[3]/32,x=n[t.i[4]],g=t.i[5],u=t.i[8]/32,f=t.i[9],m=t.i[10]*t.i[10]*4,w=t.i[11]*t.i[11]*4,A=t.i[12]*t.i[12]*4,T=1/A,M=-t.i[13]/16,E=t.i[14],C=i*2**(2-t.i[15]),v=new Int32Array(m+w+A),S=0,R=0;for(s=0,h=0;m+w+A>s;s++,h++)0>h||(h-=C,l=r(e+(15&(E=E>>8|(255&E)<<4))+t.i[2]-128),c=r(e+(15&E)+t.i[6]-128)*(1+8e-4*t.i[7])),a=1,m>s?a=s/m:m+w>s||(a=(1-(a=(s-m-w)*T))*3**(M*a)),o=d(S+=l*a**p)*y,o+=x(R+=c*a**u)*g,f&&(o+=(2*Math.random()-1)*f),v[s]=80*o*a|0;return v},n=[a,t=>.5>t%1?1:-1,t=>t%1*2-1,t=>{var e=t%1*4;return 2>e?e-1:3-e}];this.init=a=>{t=a,i=0,s=a.rowLen*a.patternLen*((e=a.endPattern)+1)*2,h=new Int32Array(s)},this.generate=()=>{var r,l,c,d,y,p,x,g,u,f,m,w,A,T,M=new Int32Array(s),E=t.songData[i],C=t.rowLen,v=t.patternLen,S=0,R=0,k=!1,I=[];for(c=0;e>=c;++c)for(x=E.p[c],d=0;v>d;++d){var D=x?E.c[x-1].f[d]:0;D&&(E.i[D-1]=E.c[x-1].f[d+v]||0,17>D&&(I=[]));var L=n[E.i[16]],B=E.i[17]/512,b=2**(E.i[18]-9)/C,P=E.i[19],G=E.i[20],H=135.82764118168*E.i[21]/44100,z=1-E.i[22]/255,F=1e-5*E.i[23],V=E.i[24]/32,U=E.i[25]/512,Y=6.283184*2**(E.i[26]-9)/C,N=E.i[27]/255,O=E.i[28]*C&-2;for(m=(c*v+d)*C,y=0;4>y;++y)if(p=x?E.c[x-1].n[d+y*v]:0){I[p]||(I[p]=o(E,p,C));var W=I[p];for(l=0,r=2*m;W.length>l;l++,r+=2)M[r]+=W[l]}for(l=0;C>l;l++)(f=M[g=2*(m+l)])||k?(w=H,P&&(w*=L(b*g)*B+.5),R+=(w=1.5*Math.sin(w))*(A=z*(f-R)-(S+=w*R)),f=3==G?R:1==G?A:S,F&&(f=1>(f*=F)?f>-1?a(.25*f):-1:1,f/=F),k=(f*=V)*f>1e-5,T=f*(1-(u=Math.sin(Y*g)*U+.5)),f*=u):T=0,O>g||(T+=M[g-O+1]*N,f+=M[g-O]*N),M[g]=0|T,M[g+1]=0|f,h[g]+=0|T,h[g+1]+=0|f}return++i/t.numChannels},this.createAudioBuffer=t=>{for(var e=t.createBuffer(2,s/2,44100),i=0;2>i;i++)for(var a=e.getChannelData(i),r=i;s>r;r+=2)a[r>>1]=h[r]/65536;return e},this.createWave=()=>{var t=44+2*s-8,e=t-36,i=new Uint8Array(44+2*s);i.set([82,73,70,70,255&t,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,255&e,e>>8&255,e>>16&255,e>>24&255]);for(var a=0,r=44;s>a;++a){var o=h[a];i[r++]=255&(o=-32767>o?-32767:o>32767?32767:o),i[r++]=o>>8&255}return i},this.getData=(t,e)=>{for(var i=2*Math.floor(44100*t),s=Array(e),a=0;2*e>a;a+=1){var r=i+a;s[a]=t>0&&h.length>r?h[r]/32768:0}return s}};function a(t,e){return Math.floor(Math.random()*(e+1-t)+t)}function o(t,e){return Math.random()*(e-t)+t}function n(t){return t[a(0,t.length-1)]}function l(t,e,i){return t+(e-t)*i}function c(t,e=0){return t.x-view.x+e>0&&t.y-view.y+e>0&&t.x-view.x-e<w&&t.y-view.y-e<h}function d(t){let e=!1;return()=>{e||(e=!0,t())}}function y(t,e,i,s){r.renderTarget=LIGHTS,r.paintTransparent=!0,r.lightMode=!0,r.radialCircle(t,e,i,s),r.renderTarget=r.SCREEN,r.paintTransparent=!1,r.lightMode=!1}function p(t,e){return!!(0===t.getTileAtPixel(e.x,e.y)|0===t.getTileAtPixel(e.x+e.width,e.y)|0===t.getTileAtPixel(e.x,e.y-e.height)|0===t.getTileAtPixel(e.x+e.width,e.y-e.height))}function x(t,e=1,i=0,s=.5,h=!1){var a=window.audioCtx.createBufferSource(),r=window.audioCtx.createGain(),o=window.audioCtx.createStereoPanner();return a.buffer=t,a.connect(o),o.connect(r),r.connect(audioMaster),a.playbackRate.value=e,a.loop=h,r.gain.value=s,o.pan.value=i,a.start(),{volume:r,sound:a}}const g={_pressed:{},_released:{},LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,ONE:49,TWO:50,THREE:51,FOUR:52,ESC:27,a:65,c:67,w:87,s:83,d:68,z:90,x:88,f:70,p:80,r:82,m:77,h:72,isDown(t){return this._pressed[t]},justReleased(t){return this._released[t]},onKeydown(t){this._pressed[t.keyCode]=!0},onKeyup(t){this._released[t.keyCode]=!0,delete this._pressed[t.keyCode]},update(){for(let t in this._released)delete this._released[t]}};function u(t,e,i){const s=e/i;let h=Math.floor(window.innerWidth/e)*e,a=h/s;a>window.innerHeight&&(a=Math.floor(window.innerHeight/i)*i,h=a*s),t.style.width=h+"px",t.style.height=a+"px"}class f{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}intersects(t){return t.x+t.width>this.x&&this.x+this.width>t.x&&t.y+t.height>this.y&&this.y+this.height>t.y}contains(t,e){return!(this.x>t||t>this.x+this.width||this.y>e||e>this.y+this.height)}}const m=potBreak={songData:[{i:[0,0,140,0,0,0,140,0,0,81,4,10,47,55,0,0,0,187,5,0,1,239,135,0,32,108,5,16,4],p:[1],c:[{n:[159,147,147,,147,,147,,,147,,,,,,,,,,,,147,,,,,,,,,,,147],f:[]}]},{i:[0,0,128,0,0,0,128,0,0,125,0,1,59,0,0,0,0,0,0,0,2,193,171,0,29,39,3,88,3],p:[2],c:[{n:[],f:[]},{n:[147],f:[]}]},{i:[3,116,128,0,0,154,140,59,0,127,2,2,47,61,0,0,0,96,3,1,3,94,79,0,32,84,2,48,4],p:[3],c:[{n:[],f:[]},{n:[],f:[]},{n:[167,167,,164,,,,163,,,,,,,,,,,,,,,,,,,,,,,,,157,,159,,150,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,159,147],f:[]}]},{i:[0,255,116,64,0,255,120,0,64,127,4,6,35,0,0,0,0,0,0,0,2,14,0,3,72,0,0,25,3],p:[4],c:[{n:[],f:[]},{n:[],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,148],f:[]}]}],rowLen:2205,patternLen:32,endPattern:0,numChannels:4},A=torch={songData:[{i:[0,0,140,0,0,0,140,0,0,81,4,11,9,1,0,0,0,187,5,0,2,47,135,0,32,108,5,16,4],p:[1],c:[{n:[135,147,,135],f:[]}]},{i:[0,101,140,0,0,0,140,0,0,255,0,19,119,89,0,0,0,51,2,1,2,21,239,0,32,88,1,157,2],p:[2],c:[{n:[],f:[]},{n:[99],f:[]}]},{i:[0,0,140,0,0,0,140,0,0,81,23,10,47,55,0,0,0,187,5,0,2,69,135,0,32,108,5,16,0],p:[2],c:[{n:[],f:[]},{n:[99],f:[]}]}],rowLen:3308,patternLen:32,endPattern:0,numChannels:3},T=spawn={songData:[{i:[0,160,128,37,0,160,128,38,64,210,23,7,52,85,0,0,0,20,3,1,2,69,0,0,13,61,5,76,2],p:[1],c:[{n:[147],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},M=tada={songData:[{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,55,6],p:[1],c:[{n:[151,151,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,154,154,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,159,159,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,135,135],f:[]}]}],rowLen:6014,patternLen:32,endPattern:0,numChannels:1},E=footstep={songData:[{i:[0,0,140,0,0,0,140,0,0,81,4,5,25,55,0,0,0,187,5,0,2,35,135,0,13,108,5,15,1],p:[1],c:[{n:[147],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},C=gremlinHurt={songData:[{i:[2,100,128,135,3,201,128,0,101,0,5,6,58,0,0,0,0,195,6,1,2,49,168,18,32,147,6,107,1],p:[1],c:[{n:[142],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},v=playerHurt={songData:[{i:[2,100,128,219,3,201,128,0,183,0,5,6,58,0,0,0,0,195,6,0,2,49,168,18,21,147,6,33,2],p:[1],c:[{n:[168,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,159,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,160],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1},S=pickup={songData:[{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,12,135,6,80,2],p:[1],c:[{n:[147,154],f:[]}]}],rowLen:5513,patternLen:32,endPattern:0,numChannels:1};class R{constructor(t,e,i,s){this.x=t,this.y=e,this.length=i,this.angle=s,this.parent=null}getEndX(){return this.x+Math.cos(this.angle)*this.length}getEndY(){return this.y+Math.sin(this.angle)*this.length}pointAt(t,e){this.angle=Math.atan2(e-this.y,t-this.x)}drag(t,e){this.pointAt(t,e),this.x=t-Math.cos(this.angle)*this.length,this.y=e-Math.sin(this.angle)*this.length,this.parent&&this.parent.drag(this.x,this.y)}}class k{constructor(t,e){this.x=t,this.y=e,this.segments=[],this.lastSegment=null,this.target={x:0,y:0}}addSegment(t){let e=new R(0,0,t,0);this.lastSegment?(e.x=this.lastSegment.getEndX(),e.y=this.lastSegment.getEndY(),e.parent=this.lastSegment):(e.x=this.x,e.y=this.y),this.segments.push(e),this.lastSegment=e}draw(){this.segments.forEach(t=>t.draw())}drag(t,e){this.lastSegment.drag(t,e)}reach(t,e){this.drag(t,e),this.segments.forEach(t=>{t.parent?(t.x=t.parent.getEndX(),t.y=t.parent.getEndY()):(t.x=this.x,t.y=this.y)})}update(){this.reach(this.target.x,this.target.y)}}class I{constructor(t,e){this.width=4,this.height=4,this.oldX=t,this.oldY=e,this.x=t,this.y=e,this.alive=!0,this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.drag=.8,this.speed=.35,this.maxSpeed=.6,this.isFiring=!1,this.gremlinBlood=0,this.currentRoom=null,this.health=100,this.maxHealth=100,this.completeAltarTorchCount=0,this.rectangle=new f(this.x,this.y,this.width,this.height),this.bodyColor=22,this.attackBoxColor=8,this.attackDamage=5,this.direction="down",this.attackBox=new f(this.x,this.y,0,0),this.legs=[new k(this.x,this.y+this.height),new k(this.x,this.y+this.height)],this.legs.forEach(t=>{t.addSegment(4),t.addSegment(4)}),this.legTargets=[{x:this.x,y:this.y+8},{x:this.x,y:this.y}],this.stepFrameCount=0}update(){this.oldX=this.x,this.oldY=this.y,this.velocity.x+=this.acceleration.x,this.velocity.x*=this.drag,this.x+=this.velocity.x,p(map,this)&&(this.x=this.oldX),this.velocity.y+=this.acceleration.y,this.velocity.y*=this.drag,this.y+=this.velocity.y,p(map,this)&&(this.y=this.oldY),this.determineDirection(),this.updateLegTargets(),this.stepFrameCount++,this.legs.forEach((t,e)=>{t.x=this.x+(0===e?0:3),t.y=this.y+this.height,t.target=this.legTargets[e],this.stepFrameCount>this.legStepOffset*e&&t.update()}),this.isFiring?this.updateAttackBox():(this.attackBox.width=0,this.attackBox.height=0),this.acceleration.x=0,this.acceleration.y=0,this.rectangle.x=this.x,this.rectangle.y=this.y}draw(t,e){this.legs.forEach(i=>i.segments.forEach(i=>{t.line(i.x-e.x,i.y-e.y,i.getEndX()-e.x,i.getEndY()-e.y,this.bodyColor)})),t.fRect(this.x-e.x,this.y-e.y-4,this.width,8,this.bodyColor),this.isFiring&&this.attackBox&&t.fRect(this.attackBox.x-e.x,this.attackBox.y-e.y,this.attackBox.width,this.attackBox.height,this.attackBoxColor),y(this.x-e.x+2,this.y-e.y+2,50,[0,1,2,3,4]),t.fRect(this.x-e.x,this.y-e.y,1,1,18),t.fRect(this.x-e.x+this.width,this.y-e.y,1,1,18),t.fRect(this.x-e.x,this.y-e.y+this.height,1,1,18),t.fRect(this.x-e.x+this.width,this.y-e.y+this.height,1,1,18),t.fRect(this.rectangle.x-e.x,this.rectangle.y-e.y,this.rectangle.width,this.rectangle.height,10)}handleInput(t){t.isDown(t.LEFT)||t.isDown(t.a)||t.isDown(t.q)?this.acceleration.x=-this.speed:(t.isDown(t.RIGHT)||t.isDown(t.d))&&(this.acceleration.x=this.speed),t.isDown(t.UP)||t.isDown(t.w)||t.isDown(t.z)?this.acceleration.y=-this.speed:(t.isDown(t.DOWN)||t.isDown(t.s))&&(this.acceleration.y=this.speed),this.isFiring=t.isDown(t.SPACE)}updateLegTargets(){let t,e;switch(this.stepDistance=16,this.legStepOffset=8,this.direction){case"up":case"down":t=this.x,e=this.y+this.height+6;break;case"left":t=this.x-6,e=this.y+this.height+6;break;case"right":t=this.x+6,e=this.y+this.height+6}this.legs.forEach((i,s)=>{const h=this.legTargets[s];Math.hypot(t-h.x,e-h.y)>this.stepDistance&&(this.legTargets[s]={x:t+(0===s?0:3),y:e},x(sounds.footstep,1,0,.1))})}updateAttackBox(){switch(this.direction){case"up":this.attackBox.x=this.x-10,this.attackBox.y=this.y-16,this.attackBox.width=24,this.attackBox.height=8;break;case"down":this.attackBox.x=this.x-10,this.attackBox.y=this.y+this.height+8,this.attackBox.width=24,this.attackBox.height=8;break;case"left":this.attackBox.x=this.x-14,this.attackBox.y=this.y-8,this.attackBox.width=8,this.attackBox.height=24;break;case"right":this.attackBox.x=this.x+14,this.attackBox.y=this.y-8,this.attackBox.width=8,this.attackBox.height=24}}determineDirection(){if(0!==this.velocity.x||0!==this.velocity.y){const t=Math.sqrt(this.velocity.x*this.velocity.x+this.velocity.y*this.velocity.y),e=this.velocity.x/t,i=this.velocity.y/t;this.direction=Math.abs(e)>Math.abs(i)?e>0?"right":"left":i>0?"down":"up"}}}class D{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.portal=null,this.altar=null,this.complete=!1,this.fill=2,this.completeColor=7}containsPlayer(t,e){return t.x/e>this.x&&this.x+this.width>t.x/e&&t.y/e>this.y&&this.y+this.height>t.y/e}draw(t,e){t.fRect(this.x-e.x,this.y-e.y,this.width,this.height,this.fill)}drawAltar(t,e){this.altar&&this.altar.draw(t,e),this.portal&&this.portal.draw(t,e)}update(t){let e=this.containsPlayer(t,8);t.currentRoom=e?this:t.currentRoom,this.altar&&this.altar.update(t),this.complete=this.altar&&this.altar.annointed,this.portal&&this.portal.update(t),this.fill=e?4:2,this.fill=this.complete?5:this.fill}}class L{constructor(t,e,i,s,h={}){this.xVelocity=i,this.yVelocity=s,this.color=h.color||22,this.life=h.life||100,this.maxLife=this.life,this.drop=h.drop||0,this.dropChance=h.dropChance||0,this.customUpdate=h.customUpdate||null,this.x=t,this.y=e,this.prevX=this.x,this.prevY=this.y,this.alive=!0,Array.isArray(this.color)?(this.colorArray=this.color,this.color=this.colorArray[0]):this.colorArray=null}update(){this.prevX=this.x,this.prevY=this.y,c({x:this.x,y:this.y})||this.die(),this.x+=this.xVelocity,this.y+=this.yVelocity,this.customUpdate&&this.customUpdate(this),this.life--,this.colorArray&&(this.color=this.colorArray[Math.floor((1-this.life/this.maxLife)*(this.colorArray.length-1))]),c({x:this.x,y:this.y})||this.die(),this.life>0||this.die()}draw(t,e){t.line(this.x-e.x,this.y-e.y,this.prevX-e.x,this.prevY-e.y,this.color)}die(){this.alive=!1}}class B{constructor(t,e){this.x=t,this.y=e,this.size=3,this.health=0,this.lit=!1,this.igniting=!1,this.annointed=!1,this.fill=2}draw(t,e){t.renderTarget=t.SCREEN,t.fCircle(this.x-e.x,this.y-e.y,this.size,this.fill),this.lit&&y(this.x-e.x,this.y-e.y,25,[0,1,2,3,4])}update(){this.fill=this.lit?6:63,this.fill=this.annointed?10:this.fill;let t=this.annointed?[10,11,12,13,14,15]:[22,8,7,6,5,4,3,2,1];this.lit&&entitiesArray.push(new L(this.x+a(-2,2),this.y,o(-.05,.05),-.25,{color:t,life:70}));let e=player.x-this.x,i=player.y-this.y;20>Math.sqrt(e*e+i*i)&&player.isFiring&&!this.lit&&!this.igniting&&(this.health=25,this.lit=!0,this.igniting=!0),this.health>0||(this.lit=!1),this.igniting&&(x(sounds.torch),this.igniting=!1)}}class b{constructor(t,e,i=3){this.x=8*t,this.y=8*e,this.radius=40,this.torchCount=i,this.torches=[],this.lit=!1,this.annointed=!1,this.fill=13,this.completeColor=10,this.generateTorches(),this.bloodRequired=20,this.playerCompleted=d(()=>{player.completeAltarTorchCount+=this.torchCount;for(let t=0;300>t;t++){let t=Math.random()*Math.PI*2;entitiesArray.push(new L(this.x+6*Math.cos(t),this.y+6*Math.sin(t),o(-2,2),o(-2,2),{color:[22,9,10,11,12,13,14,15],life:100,customUpdate(t){t.yVelocity+=o(-.5,.5),t.xVelocity+=o(-.5,.5)}}))}}),this.annointedComplete=d(()=>{})}update(){if(this.torches.forEach(t=>t.update()),this.lit=this.torches.filter(t=>t.lit).length===this.torchCount,this.annointed=this.lit&&0===this.bloodRequired,this.annointed){this.fill=this.completeColor,this.annointedComplete();for(let t=0;4>t;t++){let t=Math.random()*Math.PI*2;entitiesArray.push(new L(this.x+6*Math.cos(t),this.y+6*Math.sin(t),o(-.05,.05),o(-.1,-.3),{color:[14,13,12,11,10],life:30}))}this.lit=!0,this.torches.forEach(t=>{t.health=25,t.annointed=!0}),this.playerCompleted()}if(this.fill=this.annointed?this.completeColor:12,this.lit&&this.bloodRequired>0){let t=player.x-this.x,e=player.y-this.y;20>Math.sqrt(t*t+e*e)&&player.gremlinBlood>0&&(this.bloodRequired--,player.gremlinBlood--)}}draw(t,e){if(c({x:this.x,y:this.y},40)){for(let i=0;this.torchCount>i;i++){let s=this.torches[i],h=this.torches[(i+1)%this.torchCount];t.line(s.x-e.x,s.y-e.y,h.x-e.x,h.y-e.y,s.lit&&h.lit?22:1)}for(let i=0;this.torchCount>i;i++){let s=this.torches[i];t.line(this.x-e.x,this.y-e.y,s.x-e.x,s.y-e.y,s.lit?22:2)}t.fCircle(this.x-e.x,this.y-e.y,8,this.fill);for(let i=0;this.torchCount>i;i++)this.torches[i].draw(t,e);y(this.x-e.x,this.y-e.y,100,[2,3,4]),t.text(""+this.bloodRequired,this.x-e.x,this.y-e.y+8,1,1,"center","top",1,22)}}generateTorches(){let t=0,e=2*Math.PI/this.torchCount;for(let i=0;this.torchCount>i;i++)this.torches.push(new B(this.x+Math.cos(t)*this.radius,this.y+Math.sin(t)*this.radius)),t+=e}}class P{constructor(t,e){this.x=8*t,this.y=8*e,this.size=20,this.fill=39,this.active=!1,this.nextLevel=d(()=>{nextLevel()})}draw(t,e){t.renderTarget=t.SCREEN,t.fCircle(this.x-e.x,this.y-e.y,this.size,this.fill)}update(t){let e=t.x-this.x,i=t.y-this.y,s=Math.sqrt(e*e+i*i);13>t.completeAltarTorchCount||(this.active=!0),10>s&&this.active&&this.nextLevel()}}class G{constructor(t,e,i,s){this.width=t,this.height=e,this.maxRoomWidth=i,this.maxRoomHeight=s,this.roomCount=200,this.maxSeparationTries=2e4,this.rooms=[],this.sizeBias=5,this.biasInfluence=.6,this.featureRoomSize={width:20,height:15},this.maxGenerationTries=10,this.generateFloor()}generateFloor(){this.generateRooms(),this.separateRooms();const t=this.identifyFeatureRooms(this.featureRoomSize);this.placeAltars(t);const e=this.createGraph(t);this.mst=this.createMSTWithExtraEdges(e);const i=this.connectRooms(this.mst);this.rooms=this.rooms.filter(t=>i.has(t)),this.rooms.sort((t,e)=>t.width*t.height-e.width*e.height);let s=this.maxGenerationTries;5>this.rooms.length&&s>0&&(this.generateFloor(),s--),0===s&&console.log("Failed to generate floor")}generateRooms(){for(let t=0;this.roomCount>t;t++){const t=Math.floor(this.biasedRandom(2,this.maxRoomWidth,this.sizeBias,this.biasInfluence)),e=Math.floor(this.biasedRandom(2,this.maxRoomHeight,this.sizeBias,this.biasInfluence)),i=Math.floor(this.width/2)-Math.floor(t/2)+Math.floor(t*Math.random()),s=Math.floor(this.height/2)-Math.floor(e/2)+Math.floor(e*Math.random());this.rooms.push(new D(i,s,t,e))}}separateRooms(){for(let t=0;this.maxSeparationTries>t;t++){let t=!1;for(let e=0;this.rooms.length>e;e++)for(let i=e+1;this.rooms.length>i;i++)this.isOverlapping(this.rooms[e],this.rooms[i])&&(this.adjustPosition(this.rooms[e],this.rooms[i]),t=!0);if(!t)break}}isOverlapping(t,e){return!!(t.x+t.width>e.x&&e.x+e.width>t.x&&t.y+t.height>e.y&&e.y+e.height>t.y)}adjustPosition(t,e){const i=t.x+t.width/2-(e.x+e.width/2),s=t.y+t.height/2-(e.y+e.height/2),h=2*Math.random()-1;Math.abs(i)>Math.abs(s)?i>0?(t.x+=h,e.x-=h):(e.x+=h,t.x-=h):s>0?(t.y+=h,e.y-=h):(e.y+=h,t.y-=h)}identifyFeatureRooms(t){return this.rooms.filter(e=>e.width>t.width&&e.height>t.height)}placeAltars(t){let e=!1;t.forEach(t=>{const i=t.x+Math.floor(t.width/2),s=t.y+Math.floor(t.height/2),h=Math.floor(5*Math.random())+3;e?t.altar=new b(i,s,h):(console.log("portal placed"),t.portal=new P(i,s),portalLocation={x:i,y:s},console.log(portalLocation),e=!0)})}createGraph(t){const e=[];for(let i=0;t.length>i;i++)for(let s=i+1;t.length>s;s++){const h=t[i],a=t[s],r=this.calculateDistance(h,a);e.push({roomA:h,roomB:a,distance:r})}return e}calculateDistance(t,e){const i=t.y+t.height/2,s=e.y+e.height/2;return Math.sqrt(Math.pow(t.x+t.width/2-(e.x+e.width/2),2)+Math.pow(i-s,2))}createMST(t){t.sort((t,e)=>t.distance-e.distance);const e=[],i=new Map;return t.forEach(t=>{const s=this.find(i,t.roomA),h=this.find(i,t.roomB);s!==h&&(e.push(t),i.set(h,s))}),e}createMSTWithExtraEdges(t){const e=this.createMST(t),i=t.filter(t=>!e.includes(t));console.log(i.length);const s=Math.floor(.05*i.length);for(let t=0;s>t;t++){const t=i[Math.floor(Math.random()*i.length)];e.push(t),i.splice(i.indexOf(t),1)}return e}find(t,e){return t.has(e)||t.set(e,e),t.get(e)!==e&&t.set(e,this.find(t,t.get(e))),t.get(e)}connectRooms(t){const e=new Set;return t.forEach(t=>{e.add(t.roomA),e.add(t.roomB),this.createCorridor(t.roomA,t.roomB,e)}),e}createCorridor(t,e,i){let s=t.x+Math.floor(t.width/2),h=t.y+Math.floor(t.height/2);const a=e.x+Math.floor(e.width/2),r=e.y+Math.floor(e.height/2);for(;s!==a||h!==r;){const t=a>s?1:-1,e=r>h?1:-1;let o=s!==a?s+t+Math.floor(3*Math.random()):s,n=h!==r?h+e+Math.floor(3*Math.random()):h;o=Math.min(Math.max(o,Math.min(s,a)),Math.max(s,a)),n=Math.min(Math.max(n,Math.min(h,r)),Math.max(h,r));let l=Math.floor(5*Math.random())+1,c=Math.floor(5*Math.random())+1,d=new D(Math.min(s,o),Math.min(h,n),Math.abs(o-s)+l,Math.abs(n-h)+c);this.rooms.push(d),i.add(d),this.rooms.forEach(t=>{this.isOverlapping(d,t)&&i.add(t)}),s=o,h=n}}doesOverlap(t,e){let i=!1;return e.forEach(e=>{this.isOverlapping(t,e)&&(i=!0)}),i}isRoomIntersectingLine(t,e,i){return this.lineIntersectsRect(e.x+e.width/2,e.y+e.height/2,i.x+i.width/2,i.y+i.height/2,t.x,t.y,t.x+t.width,t.y+t.height)}lineIntersectsRect(t,e,i,s,h,a,r,o){return this.lineIntersectsLine(t,e,i,s,h,a,r,a)||this.lineIntersectsLine(t,e,i,s,r,a,r,o)||this.lineIntersectsLine(t,e,i,s,r,o,h,o)||this.lineIntersectsLine(t,e,i,s,h,o,h,a)||t>h&&r>t&&e>a&&o>e}lineIntersectsLine(t,e,i,s,h,a,r,o){const n=(r-h)*(s-e)-(o-a)*(i-t);if(0===n)return!1;const l=((r-h)*(e-a)-(o-a)*(t-h))/n,c=((i-t)*(e-a)-(s-e)*(t-h))/n;return!(0>l||l>1||0>c||c>1)}connectTwoRooms(t,e){if(t.x!==e.x){const i=Math.min(t.x,e.x),s=Math.abs(t.x-e.x);this.rooms.push(new D(i,t.y+Math.floor(t.height/2)-1,s,2))}if(t.y!==e.y){const i=Math.min(t.y,e.y),s=Math.abs(t.y-e.y);this.rooms.push(new D(e.x+Math.floor(e.width/2)-1,i,2,s))}}biasedRandom(t,e,i,s){let h=Math.random()*(e-t)+t,a=Math.random()*s;return h*(1-a)+i*a}draw(t,e){this.rooms.forEach(i=>i.draw(t,e))}}class H{constructor(t,e,i,s){this.width=t,this.height=e,this.tileSize=i,this.bufferPage=s,this.tiles=new Uint8Array(t*e),this.drawTiles=new Uint8Array(t*e),this.rooms=[],this.torches=[],this.player=null,this.preGenerate(),this.generate(),this.startTileX=0,this.startTileY=0,this.endTileX=0,this.endTileY=0}preGenerate(){}generate(){r.renderTarget=r.PAGE_3,r.clear(0,r.PAGE_3),rooms.forEach(t=>{t.draw(r,{x:0,y:0})}),r.renderTarget=r.SCREEN;for(let t=0;this.height>t;t++)for(let e=0;this.width>e;e++){let i=r.ram[this.bufferPage+t*this.width+e],s=0===i?r.LCG.choice([35,36,37,38]):r.LCG.choice([34,35]);this.tiles[t*this.width+e]=i,this.drawTiles[t*this.width+e]=s}}update(){this.generate()}draw(t,e){t.LCG.state=Math.floor(e.x/w)+Math.floor(e.y/h);for(let i=0;this.height>i;i++)for(let s=0;this.width>s;s++)c({x:s*this.tileSize,y:i*this.tileSize},8)&&(t.renderTarget=t.SCREEN,0===this.tiles[i*this.width+s]?t.drawTile(this.drawTiles[i*this.width+s],s*this.tileSize-e.x,i*this.tileSize-e.y,50,51):t.drawTile(this.drawTiles[i*this.width+s],s*this.tileSize-e.x,i*this.tileSize-e.y,34,35))}getTileAtPixel(t,e){return this.tiles[Math.floor(e/this.tileSize)*this.width+Math.floor(t/this.tileSize)]}}class z{constructor(t,e,i,s){this.x=t,this.y=e,this.lifeMax=i,this.life=i,this.alive=!0,this.color=s}update(){this.alive&&(this.life>0?this.life-=1:this.alive=!1)}draw(t,e){t.pat=t.dither[15-Math.floor(this.life/this.lifeMax*15)];for(let i=Math.floor(this.life/10);i>0;i--)t.lCircle(this.x-e.x,this.y-e.y,this.lifeMax-this.life-i,this.color,0),y(this.x-e.x,this.y-e.y,this.lifeMax-this.life-i,[3,3,0]);t.lCircle(this.x-e.x,this.y-e.y,this.lifeMax-this.life,this.color,0),t.pat=t.dither[0]}}class F{constructor(t,e,i){this.types={HEALTH:{life:500,color:5,effect(t){t.health=Math.min(t.health+1,t.maxHealth)}},GREMLIN_BLOOD:{life:500,color:11,effect(t){t.gremlinBlood+=1}}},this.x=e,this.y=i,this.oldX=e,this.oldY=i,this.alive=!0,this.type=this.types[t],this.life=t.life,this.lifeMax=this.life,this.color=this.type.color,this.effect=this.type.effect,this.velocity={x:o(-1,1),y:o(-1,1)}}update(){this.oldX=this.x,this.oldY=this.y,this.velocity.x*=.8,this.velocity.y*=.8,this.x+=this.velocity.x,p(map,this)&&(this.velocity.x*=-1),this.y+=this.velocity.y,p(map,this)&&(this.velocity.y*=-1),this.alive&&(this.life--,this.life>0||(this.alive=!1),8>Math.hypot(this.x-player.x,this.y-player.y)&&(this.effect(player),this.alive=!1,x(sounds.pickup)))}draw(t,e){t.renderTarget=t.SCREEN,t.fRect(this.x-e.x,this.y-e.y,4,4,this.color)}}class V{constructor(t,e){this.x=t,this.y=e,this.width=8,this.height=10,this.oldX=t,this.oldY=e,this.alive=!0,this.health=30,this.velocity={x:0,y:0},this.acceleration={x:0,y:0},this.drag=.8,this.speed=.25,this.maxSpeed=.3,this.attackRange=30,this.attackCooldown=1e3,this.attackTelegraphTime=500,this.isAttacking=!1,this.attackBox=new f(0,0,0,0),this.lastAttackTime=0,this.telegraphStartTime=0,this.damage=10,this.isFiring=!1,this.rectangle=new f(this.x,this.y,this.width,this.height),this.currentRoom=null,this.angleToPlayer=0,this.targetTypes={PLAYER:1,TORCH:2},this.target={type:this.targetTypes.PLAYER,x:player.x,y:player.y}}draw(t,e){if(!this.alive)return;this.isAttacking&&t.line(this.x-e.x,this.y-e.y,player.x-e.x,player.y-e.y,n([10,11,12,13])),t.fRect(this.x-e.x,this.y-e.y,8,10,16,16),y(this.x-e.x,this.y-e.y,30,[2,4]);const i=this.isAttacking?n([10,11,12,13]):16;t.fRect(this.x-e.x-2,this.y-e.y-2,2,4,i),t.fRect(this.x-e.x+6,this.y-e.y-2,2,4,i),t.text(""+this.health,this.x-e.x,this.y-e.y-16,1,1,"center","top",1,22)}update(){if(!this.alive)return;this.angleToPlayer=Math.atan2(player.y-this.y,player.x-this.x),this.currentRoom!==player.currentRoom&&(this.target.type===this.targetTypes.TORCH&&(this.target.type=this.targetTypes.PLAYER),this.currentRoom=player.currentRoom),this.checkPlayerAttack(),this.health>0||this.die();const t=Date.now();this.isAttacking?this.attackTelegraphTime-(t-this.telegraphStartTime)>0||this.performAttack():(this.oldX=this.x,this.oldY=this.y,this.seekTarget(),this.checkPlayerAttack(),this.seekWithObstacleAvoidance(),Math.hypot(this.target.x-this.x,this.target.y-this.y)>this.attackRange||this.attackCooldown>t-this.lastAttackTime?this.randomWander():this.startAttackTelegraph(),this.collideWithPlayer(),this.applyMovement())}collideWithPlayer(){if(this.rectangle.intersects(player.rectangle)){player.health-=1;let t=4;player.acceleration.x+=Math.cos(this.angleToPlayer)*t,player.acceleration.y+=Math.sin(this.angleToPlayer)*t}}checkPlayerAttack(){if(player.isFiring&&this.rectangle.intersects(player.attackBox)){this.health-=player.attackDamage;let t=12;this.acceleration.x-=Math.cos(this.angleToPlayer)*t,this.acceleration.y-=Math.sin(this.angleToPlayer)*t}}raycast(t,e,i,s,h){let a=Math.abs(i-t),r=Math.abs(s-e),o=i>t?1:-1,n=s>e?1:-1,l=a-r;for(;;){if(p(h,{x:t,y:e,width:1,height:1}))return!0;if(t===i&&e===s)break;let c=2*l;c>-r&&(l-=r,t+=o),a>c&&(l+=a,e+=n)}return!1}seekWithObstacleAvoidance(){const t=this.target.x-this.x,e=this.target.y-this.y,i=Math.hypot(t,e);if(i>0&&(this.acceleration.x=t/i*this.speed,this.acceleration.y=e/i*this.speed),this.raycast(this.x,this.y,this.target.x,this.target.y,map)){let i=.1,s=Math.atan2(e,t)-i;if(this.raycast(this.x,this.y,this.x+Math.cos(s)*this.speed,this.y+Math.sin(s)*this.speed,map)){let s=Math.atan2(e,t)+i;this.raycast(this.x,this.y,this.x+Math.cos(s)*this.speed,this.y+Math.sin(s)*this.speed,map)||(this.acceleration.x=Math.cos(s)*this.speed,this.acceleration.y=Math.sin(s)*this.speed)}else this.acceleration.x=Math.cos(s)*this.speed,this.acceleration.y=Math.sin(s)*this.speed}}seekTarget(){if(player.currentRoom.altar&&!player.currentRoom.altar.annointed){let t=null,e=1/0;for(const i of player.currentRoom.altar.torches){const s=Math.hypot(i.x-this.x,i.y-this.y);e>s&&i.health>0&&(t=i,e=s)}if(t){this.target.type=this.targetTypes.TORCH,this.target.x=t.x,this.target.y=t.y;const e=this.target.x-this.x,i=this.target.y-this.y,s=Math.hypot(e,i);return void(s>0&&(this.acceleration.x=e/s*this.speed,this.acceleration.y=i/s*this.speed))}}this.target.type=this.targetTypes.PLAYER,this.target.x=player.x,this.target.y=player.y;const t=this.target.x-this.x,e=this.target.y-this.y,i=Math.hypot(t,e);i>0&&(this.acceleration.x=t/i*this.speed,this.acceleration.y=e/i*this.speed)}randomWander(){.1>Math.random()&&(this.acceleration.x=(Math.random()-.5)*this.speed,this.acceleration.y=(Math.random()-.5)*this.speed)}startAttackTelegraph(){this.isAttacking=!0,this.telegraphStartTime=Date.now(),this.acceleration.x=0,this.acceleration.y=0}performAttack(){if(this.isAttacking=!1,this.lastAttackTime=Date.now(),this.target.type!==this.targetTypes.PLAYER||player.isFiring){if(this.target.type===this.targetTypes.TORCH)for(const t of player.currentRoom.altar.torches)if(t.x===this.target.x&&t.y===this.target.y){t.health-=this.damage;break}}else if(Math.hypot(player.x-this.x,player.y-this.y)<=this.attackRange){player.health-=this.damage;let t=6;player.acceleration.x+=Math.cos(this.angleToPlayer)*t,player.acceleration.y+=Math.sin(this.angleToPlayer)*t;let e=100;for(;e--;)entitiesArray.push(new L(player.x+o(-2,2),player.y+o(-2,2),o(-.5,.5),o(-.5,.5),{color:[22,8,7,6,5,4,3,2,1],life:100,customUpdate(t){t.xVelocity+=.3*(Math.random()-.5),t.yVelocity+=.3*(Math.random()-.5)}}))}}separate(t,e,i){let s={x:0,y:0},h=0;for(let a of e){let e=Math.sqrt((t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y));if(e>0&&i>e){let i={x:t.x-a.x,y:t.y-a.y};i.x/=e,i.y/=e,s.x+=i.x,s.y+=i.y,h++}}if(h>0){s.x/=h,s.y/=h;let e=Math.sqrt(s.x*s.x+s.y*s.y);e>0&&(s.x/=e,s.y/=e,s.x*=t.maxSpeed,s.y*=t.maxSpeed),s.x-=t.velocity.x,s.y-=t.velocity.y}return s}applyMovement(){this.separateForce=this.separate(this,gremlinsArray,20),this.acceleration.x+=this.separateForce.x,this.acceleration.y+=this.separateForce.y,this.checkPlayerAttack(),this.velocity.x+=this.acceleration.x,this.velocity.y+=this.acceleration.y,this.velocity.x*=this.drag,this.velocity.y*=this.drag,this.x+=this.velocity.x,p(map,this)&&(this.x=this.oldX,this.velocity.x=0),this.y+=this.velocity.y,p(map,this)&&(this.y=this.oldY,this.velocity.y=0),this.rectangle.x=this.x,this.rectangle.y=this.y}die(){this.alive=!1,entitiesArray.push(new z(this.x,this.y,50,5));let t=a(2,5);for(;t--;)entitiesArray.push(new L(this.x,this.y,o(-.1,.1),o(-.1,.1),{color:[16,15,14,13,12,11],life:50})),entitiesArray.push(new F("GREMLIN_BLOOD",this.x+o(-10,10),this.y+o(-10,10)))}}(()=>{document.body.style="margin:0; background-color:black; overflow:hidden";const e=480,h=270;function o(){gamebox=document.getElementById("game"),gamebox.appendChild(r.c),createEventListeners(),d()}function n(t){for(let e=0;t.length>e;e++){let i=t[e];c(i,8)&&i.draw(r,view)}}function d(){const i=performance.now(),s=i-lastFrameTime;switch(frameCount++,i-lastFrameTime<1e3/60||(fps=1e3*frameCount/(i-lastFrameTime),lastFrameTime=i,frameCount=0),gamestate){case 0:r.clear(64,r.SCREEN),r.renderTarget=r.SCREEN,text="SIX AND SEVEN",r.text(text,240,100,4,1,"center","top",4,2),r.text(audioTxt,238,130,1,1,"center","top",1,22),started?audioTxt="RETICULATING SPLINES":audioTxt="CLICK TO BEGIN GENERATION",soundsReady==totalSounds&&1==gameInitialized&&(audioTxt="ALL ASSETS CREATED.\nPRESS UP/W/Z TO CONTINUE"),(g.justReleased(g.UP)||g.justReleased(g.w)||g.justReleased(g.z))&&(gamestate=1),r.render();break;case 1:(i=>{(g.justReleased(g.ESC)||g.justReleased(g.p))&&(paused=!paused,console.log("paused",paused)),g.justReleased(g.r)&&y(),player.handleInput(g),paused||(t+=i,rooms.forEach(t=>{t.update(player)}),entitiesArray.forEach(t=>t.update()),gremlinsArray.forEach(t=>t.update()),player.update(),t%5e3<i&&(()=>{let t=player.x+a(-90,90),e=player.y+a(-90,90),i=0;for(;0==map.getTileAtPixel(t,e)&&100>i;)t=player.x+a(-90,90),e=player.y+a(-90,90),i++;100>i&&(gremlinsArray.push(new V(t,e)),x(sounds.spawn))})(),map.update(),deadzone={x:200,y:100},player.x-view.x>e-deadzone.x&&(view.target.x=player.x-e+deadzone.x),player.x-view.x<deadzone.x&&(view.target.x=player.x-deadzone.x),player.y-view.y>h-deadzone.y&&(view.target.y=player.y-h+deadzone.y),player.y-view.y<deadzone.y&&(view.target.y=player.y-deadzone.y),view.x=l(view.x,view.target.x,.1),view.y=l(view.y,view.target.y,.1))})(s),r.clear(1,r.SCREEN),r.renderTarget=LIGHTS,r.clear(0,LIGHTS),r.fRect(0,0,480,270,4,5,8),r.renderTarget=r.SCREEN,r.pat=65535,map.draw(r,view),rooms.forEach(t=>{t.drawAltar(r,view)}),n(entitiesArray),n(gremlinsArray),player.draw(r,view),generatingNewFloor&&(r.fRect(0,0,e,h,3),text="LOADING THE NEXT FLOOR",r.text(text,240,135,1,1,"center","middle",1,22)),r.pal=[65,66,67,68,69,70],r.renderSource=LIGHTS,r.renderTarget=r.SCREEN,r.spr(0,0,480,270,0,0),r.pal=r.palDefault.slice(),r.renderSource=r.PAGE_1,paused&&(r.fRect(0,0,e,h,66,67,8),text="PAUSED",r.text(text,240,135,1,1,"center","middle",1,22),r.renderSource=r.PAGE_3,r.renderTarget=r.SCREEN,r.fRect(0,0,480,270,0),r.spr(0,0,480,270,0,0),r.fRect(player.x/8-1,player.y/8-1,2,2,22),r.fRect(portalLocation.x-1,portalLocation.y-1,3,3,7)),debugText="FPS: "+fps.toFixed(2),r.text(debugText,10,10,1,1,"left","top",1,22),debugText=`${player.health.toFixed(2)}\nGB: ${player.gremlinBlood}\nAP: ${player.completeAltarTorchCount}`,r.text(debugText,player.x-view.x,player.y-view.y-28,1,1,"center","top",1,22),debugText="FLOOR: "+currentFloor,r.text(debugText,470,10,1,1,"right","top",2,22),debugText="TORCHES: "+player.completeAltarTorchCount,r.text(debugText,470,30,1,1,"right","top",2,22),r.render();break;case 2:r.clear(64,r.SCREEN),r.drawTileAsset(0,0,background1),r.drawTileAsset(0,0,platformerTest),r.drawTileAsset(0,0,tileAssetTest),n(entitiesArray),text="SIX AND SEVEN",r.text(text,240,100,4,1,"center","top",4,22),text="CLICK TO START",r.text(text,240,125,1,1,"center","top",1,22),r.render(),x(sounds.spawn)}g.update(),(t=>{for(let e=0;t.length>e;e++)t[e].alive||t.splice(e,1)})(entitiesArray),requestAnimationFrame(d)}function y(){player.completeAltarTorchCount=0,generatingNewFloor=!0,setTimeout(()=>{(()=>{currentFloor++,floors=[],entitiesArray=[],floors.push(new G(480,270,40,25)),rooms=floors[floors.length-1].rooms;let t=rooms[Math.floor(Math.random()*rooms.length)],e=t.y+t.height/2;player.x=8*(t.x+t.width/2),player.y=8*e})(),generatingNewFloor=!1},500)}window.w=e,window.h=h,(new Image).src="data:image/webp;base64,UklGRv4DAABXRUJQVlA4TPIDAAAvP8ARAPVI8f9btZVGprlDI7lrdY106y6ND41EdOuuiQ9TcJfEANzt7rX+/3XuncLLvITDAM48zk3rUm1hu95EJzm1bVtVnuHu7qSbcJfkHRJfwSDT6C4RqkaSV0ma3ar7GG6rbTue73dse4Skt5MyW7BypsgM2cSVUdm2jdN/iJKshm2eIJEJxg+B5PYXukBwVwzppmV0iwn65ymTqrOl6eTuaPwsCDxBrbd2wctDz8lyeEcisbqSnzdd9b+AESv1wolne8pwLnx6Uhs8h8BtSvmcdrwj8liaJE+Lu8d57cNpqoEIpzf+P4Twm6p7L/M39lhTp9SFGx/K8Y9o00u27CVa8GCM/ZAGy5lDATHPBZb5bodN+5t/8YmPdvPZtXGsWTciLeos1reGe1v9K+3+/eXmFLu5T9DZIO4uYu9nUe9jSZ+X8M9JzoLAa6mVkPdaXYjUMonQZhKhAxFODaWQn0LdPclXqe4uJGm79CQvtdWqqiRCPbuUzs6mUCn/pArUJGmHe5IvrUQniVABL8uXIf5XVU2VvBrntQvVEm2h3lGWLUWtav6qqYL4yeEIQQJI28EAFCp3x3CMthNx29Bo9MhqPIeAHomDpOKCTrJ7lpFcEKvZPUUSdgAdSYskoARkkJVkSQBD5iT46kiAL3gK4KsVAs/1k4AEmQINCmBm8ywV8VVmftFQs4jUSLOK1RCzYqvJCiLKwAdIiBDBAogQDbSqBkrWacY7gNCSWQGnAA46QYNXQKD4EdwLMgwAzCFywAGX0zpwj2h62NWmhAUCqAW5L6N84A14DXFf0oyA0DuC5sGqk9mqIJu5OqSGoOPNlQQ9ZimEumS0SL+glsVusO9sZv0E9p1ZDNMCs62Ag+fI1s0Fq43sTHAyYbktk741CN3+VqU9z48JlIpmZzKga4YIieAA5yHds7Sv9TVPFrAEvaeSM5yFNA36E6ho5k/TzIqI7mIZE7nhcAWmZH2kk5VuQdEmWhqTFidlS4b2ruHsYK9Xy/vSBOCa0cmJQBMBDYDbuTAwvwyJ4Wa1l5QdQai3QVuoTWjhhfzglpOgxwGBIKtgWeAMyxS2ZrRDrJCaGw+kOnW1GaY3laEZ6SuTOBuRCZSDwUUCcYEfRZD5HPWd6QN3bLb0LYwVMFzGUMwAcDkjbBf6/MI0g+57G3gFSaCg0CzqgDoMQz5yVieOEVaHXFBkKCtMccJyuhYDfhDc5SSDghey89iRB1z5etpA16kGZOeN2wjUIxAV09+8mSZQ8AUbVk6RUS3wCuoa0f/3MHCLqori5aEmzYuvsYEnyCKj/qorVACGAhc8T1BTnGdEMRfcZbBeykWiUCDeJ+Y+yg==",(()=>{const t=new Image;t.src="data:image/webp;base64,UklGRv4DAABXRUJQVlA4TPIDAAAvP8ARAPVI8f9btZVGprlDI7lrdY106y6ND41EdOuuiQ9TcJfEANzt7rX+/3XuncLLvITDAM48zk3rUm1hu95EJzm1bVtVnuHu7qSbcJfkHRJfwSDT6C4RqkaSV0ma3ar7GG6rbTue73dse4Skt5MyW7BypsgM2cSVUdm2jdN/iJKshm2eIJEJxg+B5PYXukBwVwzppmV0iwn65ymTqrOl6eTuaPwsCDxBrbd2wctDz8lyeEcisbqSnzdd9b+AESv1wolne8pwLnx6Uhs8h8BtSvmcdrwj8liaJE+Lu8d57cNpqoEIpzf+P4Twm6p7L/M39lhTp9SFGx/K8Y9o00u27CVa8GCM/ZAGy5lDATHPBZb5bodN+5t/8YmPdvPZtXGsWTciLeos1reGe1v9K+3+/eXmFLu5T9DZIO4uYu9nUe9jSZ+X8M9JzoLAa6mVkPdaXYjUMonQZhKhAxFODaWQn0LdPclXqe4uJGm79CQvtdWqqiRCPbuUzs6mUCn/pArUJGmHe5IvrUQniVABL8uXIf5XVU2VvBrntQvVEm2h3lGWLUWtav6qqYL4yeEIQQJI28EAFCp3x3CMthNx29Bo9MhqPIeAHomDpOKCTrJ7lpFcEKvZPUUSdgAdSYskoARkkJVkSQBD5iT46kiAL3gK4KsVAs/1k4AEmQINCmBm8ywV8VVmftFQs4jUSLOK1RCzYqvJCiLKwAdIiBDBAogQDbSqBkrWacY7gNCSWQGnAA46QYNXQKD4EdwLMgwAzCFywAGX0zpwj2h62NWmhAUCqAW5L6N84A14DXFf0oyA0DuC5sGqk9mqIJu5OqSGoOPNlQQ9ZimEumS0SL+glsVusO9sZv0E9p1ZDNMCs62Ag+fI1s0Fq43sTHAyYbktk741CN3+VqU9z48JlIpmZzKga4YIieAA5yHds7Sv9TVPFrAEvaeSM5yFNA36E6ho5k/TzIqI7mIZE7nhcAWmZH2kk5VuQdEmWhqTFidlS4b2ruHsYK9Xy/vSBOCa0cmJQBMBDYDbuTAwvwyJ4Wa1l5QdQai3QVuoTWjhhfzglpOgxwGBIKtgWeAMyxS2ZrRDrJCaGw+kOnW1GaY3laEZ6SuTOBuRCZSDwUUCcYEfRZD5HPWd6QN3bLb0LYwVMFzGUMwAcDkjbBf6/MI0g+57G3gFSaCg0CzqgDoMQz5yVieOEVaHXFBkKCtMccJyuhYDfhDc5SSDghey89iRB1z5etpA16kGZOeN2wjUIxAV09+8mSZQ8AUbVk6RUS3wCuoa0f/3MHCLqori5aEmzYuvsYEnyCKj/qorVACGAhc8T1BTnGdEMRfcZbBeykWiUCDeJ+Y+yg==",t.onload=()=>{let s=document.createElement("canvas");s.width=64,s.height=72;let a=s.getContext("2d");a.drawImage(t,0,0),(t=>{const s=new i(e,h,t,10);window.r=s,window.LIGHTS=s.PAGE_7,document.getElementById("game").appendChild(s.c),document.getElementById("game").style.background="none",o(),u(s.c,e,h)})(new Uint32Array(a.getImageData(0,0,64,72).data.buffer))}})(),window.t=0,text="",window.player=null,sounds={},soundsReady=0,totalSounds=4,audioTxt="",debugText="",TITLESCREEN=2,GAMESCREEN=1,gamestate=0,started=!1,window.entitiesArray=[],window.gremlinsArray=[],window.portalLocation={x:0,y:0},window.gameInitialized=!1,window.generatingNewFloor=!1,window.currentFloor=0,window.nextLevel=y,floors=[],rooms=[],map=null,fps=0,lastFrameTime=0,frameCount=0,paused=!1,tileSize=8,view={x:0,y:0,target:{x:0,y:0},w:e,h},createEventListeners=()=>{window.addEventListener("keyup",t=>{g.onKeyup(t)},!1),window.addEventListener("keydown",t=>{g.onKeydown(t)},!1),window.addEventListener("blur",()=>{paused=!0},!1),window.addEventListener("focus",()=>{paused=!1},!1),window.addEventListener("resize",()=>{u(r.c,e,h)},!1)},onclick=()=>{switch(r.c.getBoundingClientRect(),r,r,paused=!1,gamestate){case 0:0!=soundsReady||started||(started=!0,setTimeout(()=>{audioCtx=new AudioContext,audioMaster=audioCtx.createGain(),compressor=audioCtx.createDynamicsCompressor(),compressor.threshold.setValueAtTime(-60,audioCtx.currentTime),compressor.knee.setValueAtTime(40,audioCtx.currentTime),compressor.ratio.setValueAtTime(12,audioCtx.currentTime),compressor.attack.setValueAtTime(0,audioCtx.currentTime),compressor.release.setValueAtTime(.25,audioCtx.currentTime),audioMaster.connect(compressor),compressor.connect(audioCtx.destination),sndData=[{name:"tada",data:M},{name:"potBreak",data:m},{name:"torch",data:A},{name:"spawn",data:T},{name:"footstep",data:E},{name:"gremlinHurt",data:C},{name:"playerHurt",data:v},{name:"pickup",data:S}],totalSounds=sndData.length,soundsReady=0,sndData.forEach(t=>{var e=new s;e.init(t.data);var i=!1;setInterval(()=>{if(!i&&(i=1==e.generate(),soundsReady+=i,i)){let i=e.createWave().buffer;audioCtx.decodeAudioData(i,e=>{sounds[t.name]=e})}},0)}),(()=>{entitiesArray=[],gremlinsArray=[],floors.push(new G(480,270,40,25)),rooms=floors[0].rooms,window.rooms=rooms;let t=rooms[Math.floor(Math.random()*rooms.length)],e=t.x+t.width/2,i=t.y+t.height/2;player=new I(8*e,8*i),gremlin=new V(8*(e+2),8*(i+2)),gremlinsArray.push(gremlin),window.map=new H(480,270,8,r.PAGE_3),gameInitialized=!0})()},100));break;case 1:break;case 2:gamestate=1}}})()}();
